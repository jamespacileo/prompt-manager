import { expect, test, describe, beforeEach, jest } from "bun:test";
import { createPrompt, listPrompts, updatePrompt, generateTypes } from '../src/cli/commands';
import { PromptManager } from '../src/promptManager';
import fs from 'fs-extra';
import { mock } from "node:test";

mock.module('../src/promptManager', {
  defaultExport: jest.fn(),
  namedExports: {
    PromptManager: jest.fn(),
  },
});
mock.module('fs-extra', {
  defaultExport: jest.fn(),
});
const mockPromptManager = jest.fn();

describe('commands', () => {
  beforeEach(() => {
    jest.restoreAllMocks();
    console.log = jest.fn();
  });

  test('createPrompt creates a new prompt', async () => {
    await createPrompt('TEST_PROMPT', { category: 'Test' });
    expect(mockPromptManager.createPrompt).toHaveBeenCalledWith(expect.objectContaining({
      name: 'TEST_PROMPT',
      category: 'Test',
    }));
    expect(console.log).toHaveBeenCalledWith('Prompt "TEST_PROMPT" created successfully.');
  });

  test('listPrompts lists all prompts', async () => {
    mockPromptManager.listPrompts.mockResolvedValue(['PROMPT1', 'PROMPT2']);
    await listPrompts();
    expect(mockPromptManager.listPrompts).toHaveBeenCalled();
    expect(console.log).toHaveBeenCalledWith('Available prompts:');
    expect(console.log).toHaveBeenCalledWith('- PROMPT1');
    expect(console.log).toHaveBeenCalledWith('- PROMPT2');
  });

  test('updatePrompt updates an existing prompt', async () => {
    await updatePrompt('TEST_PROMPT', { content: 'Updated content' });
    expect(mockPromptManager.updatePrompt).toHaveBeenCalledWith('TEST_PROMPT', { content: 'Updated content' });
    expect(console.log).toHaveBeenCalledWith('Prompt "TEST_PROMPT" updated successfully.');
  });

  test('generateTypes generates type definitions', async () => {
    mockPromptManager.listPrompts.mockResolvedValue(['PROMPT1', 'PROMPT2']);
    mockPromptManager.getPrompt.mockResolvedValue({
      category: 'Test',
      name: 'PROMPT1',
      parameters: ['param1', 'param2'],
    });
    await generateTypes();
    expect(fs.writeFile).toHaveBeenCalledWith('prompts.d.ts', expect.any(String));
    expect(console.log).toHaveBeenCalledWith('Type definitions generated successfully.');
  });
});
